#!/usr/bin/env python
#
# License: Yujin
#
##############################################################################
# Documentation
##############################################################################
"""
Simple utility to display a gopher's configuration on the command line.
"""
##############################################################################
# Imports
##############################################################################

import sys

# Move the current directory to the end so it won't clash with python modules
# of the same name.
sys.path.append(sys.path.pop(0))

import argparse
import gopher_configuration
import rocon_console.console as console
import rocon_python_comms
import rospy

##############################################################################
# Helpers
##############################################################################


def show_description():
    s = ""
    s += console.green
    s += "Utility to display gopher configuration on the command line. "
    s += "If online, it will show the runtime configuration on the rosparam server, "
    s += "otherwise it will fallback to showing gopher configuration defaults from yaml."
    s += console.reset
    return s


def show_usage():
    s = "\n"
    s += console.bold + "    Online from RosParam" + console.reset + "\n"
    s += console.cyan + "            gopher_configuration" + console.reset + "\n"
    s += "\n"
    s += console.bold + "    Offline from Yaml Defaults" + console.reset + "\n"
    s += console.cyan + "            gopher_configuration" + console.reset + "\n"
    s += "\n"
    s += console.bold + "    Force Default Configuration Display" + console.reset + "\n"
    s += console.cyan + "            gopher_configuration --defaults" + console.reset + "\n"
    s += "\n"
    return s

##############################################################################
# Main
##############################################################################

if __name__ == '__main__':
    # just use argparse to show about and usage
    parser = argparse.ArgumentParser(description=show_description(),
                                     usage=show_usage(),
                                     epilog="And his noodly appendage reached forth to tickle the blessed...",
                                     formatter_class=argparse.RawTextHelpFormatter
                                     )
    parser.add_argument('-d', '--defaults', action='store_true', help='show gopher configuration defaults (does not need ros)')
    # don't know why I have to strip the first arg out (the executable)
    args = parser.parse_args(rospy.myargv(argv=sys.argv)[1:])

    if args.defaults:
        gopher_configuration.Configuration.load_defaults()
        gopher = gopher_configuration.Configuration()
        sys.exit(0)

    try:
        gopher = gopher_configuration.Configuration()
        print("%s" % gopher)
    except rocon_python_comms.exceptions.ROSNotFoundException:
        print(console.yellow + console.bold + "\nNot connected to ros - showing gopher configuration defaults only." + console.reset)
        gopher_configuration.Configuration.load_defaults()
        gopher = gopher_configuration.Configuration()
        print("%s" % gopher)
    except rocon_python_comms.exceptions.NotFoundException as e:
        print(console.red + "\nCould not find anything on the rosparam server, looking in the right place? [%s]\n" % str(e) + console.reset)
